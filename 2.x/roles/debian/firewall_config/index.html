<!DOCTYPE html>
<html><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>ce-provision</title>
  <meta name="viewport" content="width=device-width,minimum-scale=1">
  
  <link rel="stylesheet" href="https://codeenigma.github.io/ce-provision-docs/2.x/css/main.min.a5be948f3ce84fca7dc597e47b7bb98101cec76fa354cce27baa38078b559a24.css">
</head><body class="doc"><header><a href="https://codeenigma.github.io/ce-provision-docs/2.x/home">ce-provision</a></header><article>
        <h1 id="firewall-config">Firewall Config</h1>
<p>This role provides a wrapper for 
<a href="https://github.com/geerlingguy/ansible-role-firewall/"  target="_blank" rel="noopener">Jeff Geerling&rsquo;s Ansible firewall role for iptables</a>
.</p>
<p>Note, it explicitly does not state that dependency in <code>meta</code> because in some cases <code>iptables</code> needs installing from <code>buster-backports</code> and that cannot work if Ansible tries to install it as a dependency. This is why the first task in this role is installing <code>iptables</code> from <code>buster-backports</code> if the <code>is_local</code> variable is set (e.g we are in a 
<a href="https://github.com/codeenigma/ce-dev/"  target="_blank" rel="noopener">ce-dev</a>
 container).</p>
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<h2 id="usage">Usage</h2>
<p>The role has a concept of <code>rulesets</code> which take the form of a set of lists of firewall rules to apply. We ship some standard <code>rulesets</code>, such as this one called <code>web_open</code> which opens TCP ports 80 and 443:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">firewall_config</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">web_open</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">firewall_allowed_tcp_ports</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#34;80&#34;</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#34;443&#34;</span>
</span></span></code></pre></div><p>See the main firewall role for available options and usage: 
<a href="https://github.com/geerlingguy/ansible-role-firewall/blob/master/defaults/main.yml#L7"  target="_blank" rel="noopener">https://github.com/geerlingguy/ansible-role-firewall/blob/master/defaults/main.yml#L7</a>
</p>
<p>Your <code>firewall_config</code> rulesets can be loaded in from anywhere Ansible will load variables, so modules can invoke this role directly and set their own rulesets in their variables files. To work through an example, if I wanted to have a list of restricted IPs for SSH on a web server, I could make a custom ruleset like this in a file in <code>config/hosts/group_vars/all</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">firewall_config</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">ssh_restricted</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">firewall_additional_rules</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#34;iptables -A INPUT -p tcp --dport 22 -s 1.0.0.1 -j ACCEPT&#34;</span> <span style="color:#75715e"># old vpn</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#34;iptables -A INPUT -p tcp --dport 22 -s 1.1.1.1 -j ACCEPT&#34;</span> <span style="color:#75715e"># vpn</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#34;iptables -A INPUT -p tcp --dport 22 -s 8.8.8.8 -j ACCEPT&#34;</span> <span style="color:#75715e"># infra1</span>
</span></span></code></pre></div><p>Then in my variables for the web server I can set <code>rulesets</code> like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">firewall_config</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">rulesets</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">ssh_restricted</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">web_open</span>
</span></span></code></pre></div><p>So Ansible will apply my custom <code>ssh_restricted</code> ruleset and the built-in <code>web_open</code> ruleset.</p>
<!-- raw HTML omitted -->
<h2 id="default-variables">Default variables</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#f92672">firewall_config</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># Because firewall.bash isn&#39;t overwritten once it exists we need to delete it to apply rule changes.</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">purge</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># General settings</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># See https://github.com/geerlingguy/ansible-role-firewall/blob/master/defaults/main.yml</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">firewall_state</span>: <span style="color:#ae81ff">started</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">firewall_enabled_at_boot</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">firewall_enable_ipv6</span>: <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">firewall_log_dropped_packets</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">firewall_disable_ufw</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">firewall_allowed_tcp_ports</span>: [ <span style="color:#e6db74">&#34;22&#34;</span> ] <span style="color:#75715e"># initially open port 22 so we don&#39;t lose connection</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">rulesets</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">ssh_open</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">web_open</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># Ruleset definitions</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># Permitted rule lists</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># firewall_allowed_tcp_ports</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># firewall_allowed_udp_ports</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># firewall_forwarded_tcp_ports</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># firewall_forwarded_udp_ports</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># firewall_additional_rules</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># firewall_ip6_additional_rules</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">ssh_open</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">firewall_allowed_tcp_ports</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#34;22&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">web_open</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">firewall_allowed_tcp_ports</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#34;80&#34;</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#34;443&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">mailpit_open</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">firewall_allowed_tcp_ports</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#34;8025&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">ftp_open</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">firewall_allowed_tcp_ports</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#34;20&#34;</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#34;21&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">sftp_open</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">firewall_allowed_tcp_ports</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#34;989&#34;</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#34;990&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">letsencrypt</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">firewall_allowed_tcp_ports</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#34;80&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">ossec</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">firewall_allowed_udp_ports</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#34;1514&#34;</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#34;1515&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">openvpn</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">firewall_allowed_udp_ports</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#34;1194&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">firewall_additional_rules</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#34;echo 1 &gt; /proc/sys/net/ipv4/ip_forward&#34;</span> <span style="color:#75715e"># Enable forwarding of IP</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#34;iptables -A INPUT -s 10.8.0.0/24 -i tun0 -j ACCEPT&#34;</span> <span style="color:#75715e"># Accept traffic from the VPN on all interfaces - change this if you change openvpn_config default addresses</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#34;iptables -A FORWARD -i tun0 -o eth0 -j ACCEPT&#34;</span> <span style="color:#75715e"># Forward traffic from the VPN interface out via eth0</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#34;iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE&#34;</span> <span style="color:#75715e"># Replace the source IP with the eth0 public IP when forwarding outbound</span>
</span></span></code></pre></div><!-- raw HTML omitted -->

    </article>
    <aside>
        <nav id="TableOfContents">
  <ul>
    <li><a href="#firewall-config">Firewall Config</a>
      <ul>
        <li><a href="#usage">Usage</a></li>
        <li><a href="#default-variables">Default variables</a></li>
      </ul>
    </li>
  </ul>
</nav>
    </aside><aside class="menu">
<p> </p>
<ul>
<li>
<a href="//" >Home</a>

<ul>
<li>
<a href="//install" >Install</a>
</li>
<li>
<a href="//scripts" >Usage</a>
</li>
<li>
<a href="https://codeenigma.github.io/ce-provision-docs/2.x/roles" >Roles</a>

<ul>
<li>
<a href="//roles/aws" >AWS Infrastructure</a>

<ul>
<li>
<a href="//roles/aws/aws_acl" >AWS ACL</a>
</li>
<li>
<a href="//roles/aws/aws_acm" >AWS Certificate Manager</a>
</li>
<li>
<a href="//roles/aws/aws_ami_asg_cleanup" >AWS AMI ASG Cleanup</a>
</li>
<li>
<a href="//roles/aws/aws_ami" >AWS AMI</a>
</li>
<li>
<a href="//roles/aws/aws_backup" >AWS Backup</a>
</li>
<li>
<a href="//roles/aws/aws_backup_validation" >AWS Backup Validation</a>
</li>
<li>
<a href="//roles/aws/aws_cloudfront_distribution" >AWS CloudFront distribution</a>
</li>
<li>
<a href="//roles/aws/aws_cloudwatch_log_group" >Cloudwatch log group</a>
</li>
<li>
<a href="//roles/aws/aws_credentials" >Amazon credentials</a>
</li>
<li>
<a href="//roles/aws/aws_ec2_autoscale_cluster" >Autoscale cluster</a>
</li>
<li>
<a href="//roles/aws/aws_ec2_metric_alarm" >EC2 CloudWatch Metric Alarm</a>
</li>
<li>
<a href="//roles/aws/aws_ec2_with_eip" >EC2 instance with EIP</a>
</li>
<li>
<a href="//roles/aws/aws_efs" >AWS EFS</a>
</li>
<li>
<a href="//roles/aws/aws_elasticache" >AWS ElastiCache</a>
</li>
<li>
<a href="//roles/aws/aws_iam_role" >AWS IAM EC2</a>
</li>
<li>
<a href="//roles/aws/aws_iam_saml" >AWS IAM SAML</a>
</li>
<li>
<a href="//roles/aws/_aws_network_info" >AWS Network Info</a>
</li>
<li>
<a href="//roles/aws/aws_opensearch" >AWS OpenSearch</a>
</li>
<li>
<a href="//roles/aws/aws_provision_ec2_keypair" >AWS key pair.</a>
</li>
<li>
<a href="//roles/aws/aws_rds" >AWS RDS</a>
</li>
<li>
<a href="//roles/aws/aws_resource_group" >AWS Resource Group.</a>
</li>
<li>
<a href="//roles/aws/aws_s3_bucket" >AWS S3 Bucket</a>
</li>
<li>
<a href="//roles/aws/aws_security_groups" >AWS Security Groups</a>
</li>
<li>
<a href="//roles/aws/aws_sg_iptables" >AWS SG/firewall role</a>
</li>
<li>
<a href="//roles/aws/aws_sns" >AWS SNS</a>
</li>
<li>
<a href="//roles/aws/aws_vpc" >VPC</a>
</li>
<li>
<a href="//roles/aws/aws_vpc_route" >Update main route for a given VPC</a>
</li>
<li>
<a href="//roles/aws/aws_vpc_subnet" >VPC</a>
</li>
</ul>
</li>
<li>
<a href="//roles/contrib" >Contributed roles</a>
</li>
<li>
<a href="//roles/debian" >Debian Packages</a>

<ul>
<li>
<a href="//roles/debian/ansible_galaxy" >Ansible Galaxy</a>
</li>
<li>
<a href="//roles/debian/ansible" >Ansible</a>
</li>
<li>
<a href="//roles/debian/apache" >APACHE</a>
</li>
<li>
<a href="//roles/debian/apparmor" >Apparmor</a>
</li>
<li>
<a href="//roles/debian/apt_extra_packages" >Extra packages</a>
</li>
<li>
<a href="//roles/debian/apt_repository" >APT Repository</a>
</li>
<li>
<a href="//roles/debian/apt_unattended_upgrades" >APT Unattended Upgrades</a>
</li>
<li>
<a href="//roles/debian/aws_cli" >AWS CLI</a>
</li>
<li>
<a href="//roles/debian/aws_cloudwatch_agent" >AWS Cloudwatch agent</a>
</li>
<li>
<a href="//roles/debian/aws_efs_client" >EFS client</a>
</li>
<li>
<a href="//roles/debian/aws_ssm_agent" >AWS SSM agent</a>
</li>
<li>
<a href="//roles/debian/ce_deploy" >ce-deploy</a>
</li>
<li>
<a href="//roles/debian/ce_dev" >Extra packages</a>
</li>
<li>
<a href="//roles/debian/ce_patcher" >Automated patching</a>
</li>
<li>
<a href="//roles/debian/ce_provision" >ce-provision</a>
</li>
<li>
<a href="//roles/debian/clamav" >ClamAV</a>
</li>
<li>
<a href="//roles/debian/docker_ce" >Docker CE</a>
</li>
<li>
<a href="//roles/debian/docker_registry" >Docker Registry</a>
</li>
<li>
<a href="//roles/debian/duplicity" >Duplicity</a>
</li>
<li>
<a href="//roles/debian/firewall_config" >Firewall Config</a>
</li>
<li>
<a href="//roles/debian/frontail" >Frontail</a>
</li>
<li>
<a href="//roles/debian/gitlab" >Gitlab</a>
</li>
<li>
<a href="//roles/debian/gitlab_runner" >Gitlab Runner</a>
</li>
<li>
<a href="//roles/debian/gpg_key" >GPG Key</a>
</li>
<li>
<a href="//roles/debian/haproxy" >HA Proxy</a>
</li>
<li>
<a href="//roles/debian/hosts" >Managed /etc/hosts</a>
</li>
<li>
<a href="//roles/debian/jenkins" >Jenkins</a>
</li>
<li>
<a href="//roles/debian/jitsi" >Jitsi</a>
</li>
<li>
<a href="//roles/debian/ldap_server" >LDAP Server</a>
</li>
<li>
<a href="//roles/debian/lhci" >LHCI</a>
</li>
<li>
<a href="//roles/debian/mailpit" >Mailpit</a>
</li>
<li>
<a href="//roles/debian/mount_sync" >Mount sync</a>
</li>
<li>
<a href="//roles/debian/mysql_client" >MariaDB Client</a>
</li>
<li>
<a href="//roles/debian/mysql_server_oracle_ce" >MySQL Server - Oracle Community Edition</a>
</li>
<li>
<a href="//roles/debian/nginx" >NGINX</a>
</li>
<li>
<a href="//roles/debian/nodejs" >NodeJS</a>
</li>
<li>
<a href="//roles/debian/openvpn" >OpenVPN</a>
</li>
<li>
<a href="//roles/debian/packer" >Packer</a>
</li>
<li>
<a href="//roles/debian/pam_linotp" >PAM LinOTP</a>
</li>
<li>
<a href="//roles/debian/php-cli" >PHP terminal client</a>
</li>
<li>
<a href="//roles/debian/php-common" >PHP common components</a>
</li>
<li>
<a href="//roles/debian/php_composer" >PHP Composer</a>
</li>
<li>
<a href="//roles/debian/php-fpm" >PHP-FPM</a>
</li>
<li>
<a href="//roles/debian/phpmyadmin" >phpMyAdmin</a>
</li>
<li>
<a href="//roles/debian/php_xdebug" >PHP XDebug</a>
</li>
<li>
<a href="//roles/debian/postfix" >Postfix</a>
</li>
<li>
<a href="//roles/debian/process_manager" >Process Manager</a>
</li>
<li>
<a href="//roles/debian/python_boto" >Python Boto</a>
</li>
<li>
<a href="//roles/debian/python_common" >Python Common</a>
</li>
<li>
<a href="//roles/debian/python_pip_packages" >Python Pip Packages</a>
</li>
<li>
<a href="//roles/debian/rkhunter" >rkhunter</a>
</li>
<li>
<a href="//roles/debian/rsyslog" >Rsyslog</a>
</li>
<li>
<a href="//roles/debian/solr" >solr</a>
</li>
<li>
<a href="//roles/debian/ssh_server" >SSHD</a>
</li>
<li>
<a href="//roles/debian/ssl" >SSL</a>
</li>
<li>
<a href="//roles/debian/sudo_config" >sudo config</a>
</li>
<li>
<a href="//roles/debian/swap" >Swap</a>
</li>
<li>
<a href="//roles/debian/system" >System</a>
</li>
<li>
<a href="//roles/debian/user_ansible" >User Ansible</a>
</li>
<li>
<a href="//roles/debian/varnish_config" >varnish_config</a>
</li>
<li>
<a href="//roles/debian/wazuh" >wazuh</a>
</li>
</ul>
</li>
<li>
<a href="//roles/_init" >Init role</a>
</li>
<li>
<a href="//roles/_meta" >&ldquo;Meta&rdquo; roles that group individual roles together.</a>

<ul>
<li>
<a href="//roles/_meta/aws_account" >AWS account</a>
</li>
<li>
<a href="//roles/_meta/aws_client_instance" >AWS client</a>
</li>
<li>
<a href="//roles/_meta/aws_region" >AWS region</a>
</li>
</ul>
</li>
<li>
<a href="//roles/_overrides" >_overrides.</a>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</aside>
    </body>
</html>
